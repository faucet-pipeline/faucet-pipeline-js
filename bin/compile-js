#!/usr/bin/env node
"use strict";

let bundler = require("../src");
let parseArgs = require("minimist");
let fs = require("fs");
let path = require("path");

// command-line arguments
// TODO:
// * help message
// * optionally disable fingerprinting
let argv = parseArgs(process.argv.slice(2), {
	alias: {
		c: "config",
		m: "minify",
		w: "watch"
	},
	default: {
		config: "package.json"
	}
});

let rootDir = process.cwd();
let config = readConfig(path.join(rootDir, argv.config), "jsConfig");
bundler(config.bundles, config.targetDir, {
	rootDir,
	watch: argv.watch && (argv.poll ? "poll" : true)
});

// TODO: human-friendly error reporting
function readConfig(filepath, property) {
	let json = fs.readFileSync(filepath);
	let config = JSON.parse(json);
	return config[property];
}
