#!/usr/bin/env node
"use strict";

let bundler = require("../src");
let parseArgs = require("minimist");
let fs = require("fs");
let path = require("path");

// command-line arguments
// TODO: help message, documenting options (incl. `--no-fingerprint` and `--poll`)
let argv = parseArgs(process.argv.slice(2), {
	alias: {
		c: "config",
		m: "minify",
		w: "watch"
	},
	default: {
		config: "package.json"
	}
});

let rootDir = process.cwd();
let config = readConfig(path.join(rootDir, argv.config), "jsConfig");
let options = {
	rootDir,
	watch: argv.watch && (argv.poll ? "poll" : true),
	suppressFingerprinting: argv.fingerprint === false
};

if(options.watch) {
	console.error(`monitoring file system at ${rootDir}`);

	if(!options.suppressFingerprinting) { // for convenience
		console.error("you might consider using `--no-fingerprint` to avoid " +
				"littering your file system with obsolete bundles");
	}
}

bundler(config.bundles, config.targetDir, config.manifest, options);

// TODO: human-friendly error reporting
function readConfig(filepath, property) {
	let json = fs.readFileSync(filepath);
	let config = JSON.parse(json);
	return config[property];
}
