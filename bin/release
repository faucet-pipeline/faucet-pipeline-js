#!/usr/bin/env bash

set -eu

root=`dirname $0`
root=`node -r fs -p "fs.realpathSync(process.argv[1]);" "$root/.."`

. ./node_modules/release-util-fnd/lib.sh

"$root/bin/update-pkg"

# ensure meta-packages are in sync and up to date
version=`determine_version "."`
packages=`find "$root/pkg" -type d -d 1`
for dir in $packages; do
	package=`basename $dir`
	_version=`determine_version "./pkg/$package"`
	if [ "$_version" != "$version" ]; then
		abort "version mismatch in $package"
	fi
	unset _version
done
"$root/bin/validate-dependencies" faucet-pipeline-js $packages
unset version

pre_release_checks
npm test

target_dir=`create_package`
# remove meta-packages
rm -r "$target_dir/pkg"

publish_package
for dir in $packages; do
	(cd "$dir"; echo "about to publish `basename $dir`"; npm publish)
done
